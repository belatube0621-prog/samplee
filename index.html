<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Menu & Ordering System</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        :root {
            --primary-color: #f9fafb; /* Default background */
            --secondary-color: #1f2937; /* Default text */
        }
        body {
            background-color: var(--primary-color);
            color: var(--secondary-color);
        }
        .menu-item {
            transition: transform 0.2s;
        }
        .menu-item:hover {
            transform: scale(1.05);
        }
        #login-modal, #kitchen-view {
            background-color: rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="font-sans">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-2xl font-bold mb-4">Login</h2>
            <div class="space-y-4">
                <div>
                    <label for="username-input" class="block">Username:</label>
                    <input type="text" id="username-input" class="w-full p-2 border rounded" value="owner">
                </div>
                <div>
                    <label for="password-input" class="block">Password:</label>
                    <input type="password" id="password-input" class="w-full p-2 border rounded" value="kitchenpass456">
                </div>
                <div class="flex justify-end space-x-2">
                     <button onclick="hideLoginModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                    <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gray-800 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <img id="logo" src="https://via.placeholder.com/50" alt="Logo" class="h-12 w-12 mr-4 rounded-full">
                <div>
                    <h1 id="hotel-name" class="text-2xl font-bold">Hotel Name</h1>
                    <p id="hotel-address" class="text-sm">123 Main Street, Cityville, ST 12345</p>
                </div>
            </div>
             <div class="flex items-center space-x-4">
                <div id="social-media" class="flex space-x-4">
                    <a href="#" class="text-white hover:text-gray-400">Facebook</a>
                    <a href="#" class="text-white hover:text-gray-400">Instagram</a>
                    <a href="#" class="text-white hover:text-gray-400">Twitter</a>
                </div>
                <button id="login-button" onclick="showLoginModal()" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600">Owner Login</button>
                <button id="logout-button" onclick="logout()" class="hidden bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">Logout</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav id="main-nav" class="bg-gray-700 p-2 sticky top-0 z-40">
        <!-- JS will populate this based on user role -->
    </nav>

    <main class="container mx-auto p-4">
        <!-- GUEST VIEWS -->
        <section id="menu-view">
            <h2 class="text-3xl font-bold mb-4 border-b pb-2">Menu</h2>
            <div class="mb-4 flex space-x-4">
                <input type="text" id="menu-search" placeholder="Search for a dish..." onkeyup="renderMenu()" class="w-full p-2 border rounded">
                <select id="language-selector" onchange="renderMenu()" class="bg-white border text-gray-800 p-2 rounded">
                    <option value="en">English</option>
                    <option value="am">Amharic</option>
                    <option value="om">Afan Oromo</option>
                    <option value="ti">Tigrigna</option>
                </select>
            </div>
            <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>

        <section id="order-history-view" class="hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-3xl font-bold">My Order History</h2>
                <button onclick="clearOrderHistory()" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Clear My History</button>
            </div>
            <div id="order-history-container"></div>
        </section>

        <section id="photo-upload-view" class="hidden">
            <h2 class="text-3xl font-bold mb-4 border-b pb-2">Upload a Photo</h2>
            <input type="file" id="photo-input" class="mb-4">
            <div id="photo-preview-container"></div>
        </section>

        <!-- OWNER VIEWS -->
        <section id="owner-dashboard-view" class="hidden">
            <h2 class="text-3xl font-bold mb-4 border-b pb-2">Owner Dashboard</h2>
            <p>Welcome, Owner. Manage your restaurant from here.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-xl font-bold">All Orders</h3>
                    <div id="all-orders-owner-summary" class="mt-2"></div>
                </div>
                 <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-xl font-bold">Quick Stats</h3>
                    <p>Total Orders: <span id="total-orders-stat">0</span></p>
                    <p>Total Revenue: $<span id="total-revenue-stat">0.00</span></p>
                </div>
            </div>
        </section>
        
        <section id="all-orders-view" class="hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-3xl font-bold">All Guest Orders</h2>
                <button onclick="printAllOrders()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">Print All Orders</button>
            </div>
            <div id="all-orders-container"></div>
        </section>
        
        <section id="edit-menu-view" class="hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                 <h2 class="text-3xl font-bold">Edit Menu</h2>
                 <button onclick="openMenuEditorModal()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add New Item</button>
            </div>
            <div id="menu-editor-container" class="space-y-4"></div>
        </section>


        <section id="settings-view" class="hidden">
            <h2 class="text-3xl font-bold mb-4 border-b pb-2">Website Settings</h2>
            <div class="space-y-4 bg-white p-6 rounded-lg shadow">
                 <h3 class="text-xl font-bold mb-2">Branding & Appearance</h3>
                <div>
                    <label for="hotel-name-input" class="block">Hotel Name:</label>
                    <input type="text" id="hotel-name-input" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="hotel-address-input" class="block">Address:</label>
                    <input type="text" id="hotel-address-input" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="logo-url-input" class="block">Logo URL:</label>
                    <input type="text" id="logo-url-input" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="facebook-url-input" class="block">Facebook URL:</label>
                    <input type="text" id="facebook-url-input" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="instagram-url-input" class="block">Instagram URL:</label>
                    <input type="text" id="instagram-url-input" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="twitter-url-input" class="block">Twitter URL:</label>
                    <input type="text" id="twitter-url-input" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label for="bg-color-input" class="block">Background Color:</label>
                    <input type="color" id="bg-color-input" class="p-1 h-10 w-14 block border cursor-pointer rounded">
                </div>
                <div>
                    <label for="text-color-input" class="block">Text Color:</label>
                    <input type="color" id="text-color-input" class="p-1 h-10 w-14 block border cursor-pointer rounded">
                </div>
                <button onclick="applySettings()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save General Settings</button>

                <div class="mt-8 pt-4 border-t">
                    <h3 class="text-xl font-bold mb-2">Security Settings</h3>
                    <div>
                        <label for="new-username-input" class="block">New Username:</label>
                        <input type="text" id="new-username-input" class="w-full p-2 border rounded">
                    </div>
                    <div class="mt-2">
                        <label for="new-password-input" class="block">New Password:</label>
                        <input type="password" id="new-password-input" class="w-full p-2 border rounded" placeholder="Leave blank to keep current password">
                    </div>
                    <button onclick="updateCredentials()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 mt-4">Update Credentials</button>
                </div>
            </div>
        </section>

        <!-- KITCHEN VIEW -->
        <div id="kitchen-view" class="fixed inset-0 z-50 flex items-center justify-center hidden">
             <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl h-5/6 overflow-y-auto">
                <h2 class="text-3xl font-bold mb-4 border-b pb-2">Live Kitchen Orders</h2>
                <div id="kitchen-orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Kitchen orders will be injected here -->
                </div>
            </div>
        </div>

    </main>

    <!-- Floating Cart (Guest only) -->
    <div id="cart-container" class="fixed bottom-4 right-4">
        <div class="bg-white rounded-lg shadow-xl p-4 w-80 border">
            <h3 class="text-xl font-bold">Current Order</h3>
            <div id="cart-items" class="my-2 max-h-40 overflow-y-auto">Your cart is empty.</div>
            <div class="mt-2">
                <label for="order-preferences" class="block text-sm font-medium">Allergies or Preferences:</label>
                <textarea id="order-preferences" rows="2" class="w-full p-2 border rounded" placeholder="e.g., no nuts, extra spicy"></textarea>
            </div>
            <div id="cart-total" class="font-bold text-lg border-t pt-2 mt-2">Total: $0.00</div>
            <button onclick="placeOrder()" class="bg-green-500 text-white w-full py-2 mt-2 rounded hover:bg-green-600">Place Order</button>
        </div>
    </div>
    
    <!-- Menu Item Editor Modal -->
    <div id="menu-editor-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden" style="background-color: rgba(0,0,0,0.5);">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 id="menu-editor-title" class="text-2xl font-bold mb-4">Add Menu Item</h2>
            <form id="menu-editor-form" onsubmit="saveMenuItem(event)" class="space-y-4">
                <input type="hidden" id="menu-item-id">
                <div>
                    <label for="menu-item-lang" class="block">Language:</label>
                    <select id="menu-item-lang" class="w-full p-2 border rounded">
                        <option value="en">English</option>
                        <option value="am">Amharic</option>
                        <option value="om">Afan Oromo</option>
                        <option value="ti">Tigrigna</option>
                    </select>
                </div>
                <div>
                    <label for="menu-item-category" class="block">Category Name:</label>
                    <input type="text" id="menu-item-category" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label for="menu-item-name" class="block">Item Name:</label>
                    <input type="text" id="menu-item-name" class="w-full p-2 border rounded" required>
                </div>
                 <div>
                    <label for="menu-item-description" class="block">Description:</label>
                    <textarea id="menu-item-description" rows="3" class="w-full p-2 border rounded" required></textarea>
                </div>
                <div>
                    <label for="menu-item-price" class="block">Price:</label>
                    <input type="number" step="0.01" id="menu-item-price" class="w-full p-2 border rounded" required>
                </div>
                <div>
                    <label for="menu-item-tags" class="block">Tags (comma-separated):</label>
                    <input type="text" id="menu-item-tags" class="w-full p-2 border rounded" placeholder="e.g. vegetarian, spicy, gluten-free">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeMenuEditorModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifications-container" class="fixed top-20 right-4 space-y-2 z-50"></div>

    <audio id="notification-sound" src="https://cdn.freesound.org/previews/242/242857_4284968-lq.mp3" preload="auto"></audio>

    <!-- ADD FIREBASE SDKs HERE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE ---
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_AUTH_DOMAIN",
          // Make sure to include your DATABASE URL here
          databaseURL: "https://restaurant-management-cef63-default-rtdb.firebaseio.com",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_STORAGE_BUCKET",
          messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
          appId: "YOUR_APP_ID"
        };
        
        // --- INITIALIZE FIREBASE AND DATABASE ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- DATA & STATE ---
        let menuData = {};
        let userState = { role: 'guest', isLoggedIn: false };
        let credentials = {};
        let currentOrder = [];
        let guestOrderHistory = [];
        let allOrders = [];

        // --- CORE FUNCTIONS ---
        function showView(viewId) {
            document.querySelectorAll('main > section').forEach(section => section.classList.add('hidden'));
            if(viewId) {
                const view = document.getElementById(viewId + '-view');
                if (view) {
                    view.classList.remove('hidden');
                    if (viewId === 'edit-menu') renderMenuEditor();
                    if (viewId === 'all-orders') renderAllOrders();
                    if (viewId === 'owner-dashboard') loadOwnerDashboard();
                }
            }
            document.getElementById('kitchen-view').classList.add('hidden');
            if (viewId === 'kitchen') {
                document.getElementById('kitchen-view').classList.remove('hidden');
                renderKitchenOrders();
            }
        }
        
        function updateNav() {
            const nav = document.getElementById('main-nav');
            const cart = document.getElementById('cart-container');
            let navLinks = '';

            if (userState.role === 'owner') {
                navLinks = \`
                    <button onclick="showView('owner-dashboard')" class="px-3 py-2 rounded hover:bg-gray-600">Dashboard</button>
                    <button onclick="showView('all-orders')" class="px-3 py-2 rounded hover:bg-gray-600">All Orders</button>
                    <button onclick="showView('edit-menu')" class="px-3 py-2 rounded hover:bg-gray-600">Edit Menu</button>
                    <button onclick="showView('settings')" class="px-3 py-2 rounded hover:bg-gray-600">Settings</button>
                    <button onclick="showView('kitchen')" class="px-3 py-2 rounded hover:bg-gray-600">Kitchen View</button>
                    <button onclick="logout()" class="px-3 py-2 rounded hover:bg-gray-600">Switch to Guest View</button>
                \`;
                cart.classList.add('hidden');
                document.getElementById('login-button').classList.add('hidden');
                document.getElementById('logout-button').classList.remove('hidden');
            } else { // Guest
                navLinks = \`
                    <button onclick="showView('menu')" class="px-3 py-2 rounded hover:bg-gray-600">Menu</button>
                    <button onclick="showView('order-history')" class="px-3 py-2 rounded hover:bg-gray-600">My Orders</button>
                    <button onclick="showView('photo-upload')" class="px-3 py-2 rounded hover:bg-gray-600">Upload Photo</button>
                \`;
                cart.classList.remove('hidden');
                document.getElementById('login-button').classList.remove('hidden');
                document.getElementById('logout-button').classList.add('hidden');
            }
            nav.innerHTML = \`<div class="container mx-auto flex justify-between items-center text-white">\${navLinks}</div>\`;
        }

        // --- LOGIN & CREDENTIALS ---
        function showLoginModal() { document.getElementById('login-modal').classList.remove('hidden'); }
        function hideLoginModal() { document.getElementById('login-modal').classList.add('hidden'); }

        function login() {
            const user = document.getElementById('username-input').value;
            const pass = document.getElementById('password-input').value;
            if (user === credentials.username && pass === credentials.password) {
                userState.role = 'owner';
                userState.isLoggedIn = true;
                hideLoginModal();
                updateNav();
                showView('owner-dashboard');
                showNotification('Owner login successful!', 'success');
            } else {
                showNotification('Invalid credentials.', 'error');
            }
        }

        function logout() {
            userState.role = 'guest';
            userState.isLoggedIn = false;
            updateNav();
            showView('menu');
            showNotification('Logged out.', 'info');
        }

        function updateCredentials() {
            const newUsername = document.getElementById('new-username-input').value.trim();
            const newPassword = document.getElementById('new-password-input').value.trim();

            if (!newUsername) {
                showNotification('Username cannot be empty.', 'error');
                return;
            }

            const newCreds = {
                username: newUsername,
                password: newPassword ? newPassword : credentials.password
            };
            
            db.ref('settings/credentials').set(newCreds)
                .then(() => {
                    document.getElementById('new-password-input').value = '';
                    showNotification('Credentials updated successfully!', 'success');
                })
                .catch(err => showNotification('Error updating credentials.', 'error'));
        }

        // --- MENU & ORDERING ---
        function renderMenu() {
            const lang = document.getElementById('language-selector').value;
            const searchTerm = document.getElementById('menu-search').value.toLowerCase();
            const menu = menuData ? menuData[lang] : null;
            const container = document.getElementById('menu-container');
            container.innerHTML = '';
            if (!menu || !menu.categories) {
                 container.innerHTML = '<p>Menu is loading or not available...</p>';
                 return;
            }

            menu.categories.forEach(category => {
                const filteredItems = category.items.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) || 
                    item.description.toLowerCase().includes(searchTerm) ||
                    (item.tags && Array.isArray(item.tags) && item.tags.some(t => t.toLowerCase().includes(searchTerm)))
                );

                if (filteredItems.length > 0) {
                    let categoryHtml = \`<div class="col-span-1 md:col-span-2 lg:col-span-3"><h3 class="text-2xl font-semibold mb-2">\${category.name}</h3></div>\`;
                    container.innerHTML += categoryHtml;
                    filteredItems.forEach(item => {
                        const tagsHtml = item.tags && item.tags.length > 0 
                            ? \`<div class="flex flex-wrap gap-2 mt-2">\${item.tags.map(tag => \`<span class="bg-gray-200 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full">\${tag}</span>\`).join('')}</div>\`
                            : '';
                        const itemHtml = \`
                            <div class="menu-item bg-white p-4 rounded-lg shadow-md cursor-pointer" onclick="addToOrder('\${item.id}')">
                                <h4 class="text-xl font-bold">\${item.name}</h4>
                                <p class="text-gray-600">\${item.description}</p>
                                <p class="text-lg font-semibold mt-2">$ \${item.price.toFixed(2)}</p>
                                \${tagsHtml}
                            </div>
                        \`;
                        container.innerHTML += itemHtml;
                    });
                }
            });
        }
        
        function findMenuItem(itemId) {
            if (!menuData) return null;
            for (const lang in menuData) {
                if (menuData[lang] && menuData[lang].categories) {
                    for (const category of menuData[lang].categories) {
                        const item = category.items.find(i => i.id === itemId);
                        if (item) return item;
                    }
                }
            }
            return null;
        }

        function renderCart() { 
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            if (currentOrder.length === 0) {
                cartItemsContainer.innerHTML = 'Your cart is empty.';
                cartTotalEl.innerText = 'Total: $0.00';
                return;
            }

            cartItemsContainer.innerHTML = '';
            let total = 0;
            currentOrder.forEach((item, index) => {
                cartItemsContainer.innerHTML += \`
                    <div class="flex justify-between items-center text-sm py-1">
                        <div>\${item.name}</div>
                        <div class="flex items-center">
                            <span class="mr-4">$\${item.price.toFixed(2)}</span>
                            <button onclick="removeFromOrder(\${index})" class="text-red-500 font-bold hover:text-red-700">X</button>
                        </div>
                    </div>
                \`;
                total += item.price;
            });
            cartTotalEl.innerText = \`Total: $\${total.toFixed(2)}\`;
        }

        function addToOrder(itemId) {
            const item = findMenuItem(itemId);
            if(item) {
                currentOrder.push({ id: item.id, name: item.name, price: item.price });
                renderCart();
                showNotification(\`Added \${item.name} to your order.\`);
            }
        }

        function removeFromOrder(index) {
            const itemName = currentOrder[index].name;
            currentOrder.splice(index, 1);
            renderCart();
            showNotification(\`Removed \${itemName} from your order.\`, 'error');
        }

        function placeOrder() {
            if (currentOrder.length === 0) {
                showNotification('Your cart is empty!', 'error');
                return;
            }
            
            const tableNumber = prompt("Please enter your Table or Room Number:");
            if (!tableNumber) {
                showNotification('Order cancelled. Table/Room number is required.', 'error');
                return;
            }

            const preferences = document.getElementById('order-preferences').value;
            const total = currentOrder.reduce((sum, item) => sum + item.price, 0);
            const newOrder = {
                date: new Date().toISOString(),
                items: [...currentOrder],
                total: total,
                table: tableNumber,
                status: 'new', // new, preparing, ready, delivered
                preferences: preferences
            };

            // Pushes the new order to Firebase, which generates a unique ID
            db.ref('orders').push(newOrder).then(() => {
                showNotification('Order placed successfully!', 'success');
                // Also save to guest's local history (this is device-specific)
                guestOrderHistory.unshift({ ...newOrder, id: Date.now() }); // Add a temporary ID for local use
                localStorage.setItem('guestOrderHistory', JSON.stringify(guestOrderHistory));
                renderOrderHistory();

                // Clear the cart
                currentOrder = [];
                document.getElementById('order-preferences').value = '';
                renderCart();
            }).catch(err => {
                showNotification('Failed to place order. Please try again.', 'error');
            });
        }

        // --- ORDER HISTORY & VIEWS ---
        function renderOrderHistory() {
            const container = document.getElementById('order-history-container');
            container.innerHTML = guestOrderHistory.length === 0 ? '<p>No past orders found on this device.</p>' : guestOrderHistory.map(order => \`
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 class="font-bold text-lg">Order for Table/Room: \${order.table} - \${new Date(order.date).toLocaleString()}</h3>
                    <p>Total: $\${order.total.toFixed(2)}</p>
                    <p>Status: <span class="font-semibold uppercase">\${order.status || 'new'}</span></p>
                    \${order.preferences ? \`<p class="mt-1"><strong class="font-semibold">Preferences:</strong> \${order.preferences}</p>\` : ''}
                    <ul class="list-disc pl-5 mt-2">
                        \${order.items.map(item => \`<li>\${item.name} - $\${item.price.toFixed(2)}</li>\`).join('')}
                    </ul>
                </div>
            \`).join('');
        }
        
        function clearOrderHistory() {
            if (confirm("Are you sure you want to clear your personal order history from this device? This cannot be undone.")) {
                guestOrderHistory = [];
                localStorage.setItem('guestOrderHistory', '[]');
                renderOrderHistory();
                showNotification('Your order history has been cleared.', 'info');
            }
        }
        
        function renderAllOrders() {
            const container = document.getElementById('all-orders-container');
            if (allOrders.length === 0) {
                 container.innerHTML = '<p>No orders found.</p>';
                 return;
            }
            
            const sortedOrders = [...allOrders].sort((a, b) => new Date(b.date) - new Date(a.date));

            container.innerHTML = sortedOrders.map(order => \`
                 <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <h3 class="font-bold text-lg">Order for Table/Room: \${order.table} - \${new Date(order.date).toLocaleString()}</h3>
                    <p>Total: $\${order.total.toFixed(2)}</p>
                    <p>Status: <span class="font-semibold uppercase">\${order.status}</span></p>
                    \${order.preferences ? \`<p class="mt-1 text-red-600"><strong class="font-semibold text-red-700">Preferences:</strong> \${order.preferences}</p>\` : ''}
                    <ul class="list-disc pl-5 mt-2">\${order.items.map(item => \`<li>\${item.name}</li>\`).join('')}</ul>
                    <div class="mt-2 space-x-2">
                        <button onclick="updateOrderStatus('\${order.id}', 'new')" class="bg-gray-500 text-white px-2 py-1 text-sm rounded">New</button>
                        <button onclick="updateOrderStatus('\${order.id}', 'preparing')" class="bg-yellow-500 text-white px-2 py-1 text-sm rounded">Preparing</button>
                        <button onclick="updateOrderStatus('\${order.id}', 'ready')" class="bg-green-500 text-white px-2 py-1 text-sm rounded">Ready</button>
                        <button onclick="updateOrderStatus('\${order.id}', 'delivered')" class="bg-blue-500 text-white px-2 py-1 text-sm rounded">Delivered</button>
                    </div>
                </div>
            \`).join('');
        }

        function renderKitchenOrders() {
            const container = document.getElementById('kitchen-orders-container');
            const activeOrders = allOrders.filter(o => ['new', 'preparing'].includes(o.status));
            
            const sortedActiveOrders = activeOrders.sort((a,b) => new Date(a.date) - new Date(b.date));

            container.innerHTML = sortedActiveOrders.length === 0 ? '<p class="col-span-3 text-center">No new orders.</p>' : sortedActiveOrders.map(order => \`
                 <div class="bg-white p-4 rounded-lg shadow-md border-l-8 \${order.status === 'new' ? 'border-red-500' : 'border-yellow-500'}">
                    <h3 class="font-bold text-xl">Table/Room: \${order.table}</h3>
                    <p class="text-sm text-gray-500">\${new Date(order.date).toLocaleTimeString()}</p>
                     \${order.preferences ? \`<p class="mt-2 text-red-600 font-semibold"><strong class="font-bold">Note:</strong> \${order.preferences}</p>\` : ''}
                    <ul class="list-disc pl-5 my-2">\${order.items.map(item => \`<li class="font-semibold">\${item.name}</li>\`).join('')}</ul>
                     <div class="mt-4">
                        \${order.status === 'new' ? \`<button onclick="updateOrderStatus('\${order.id}', 'preparing')" class="w-full bg-yellow-500 text-white py-1 rounded">Start Preparing</button>\` : ''}
                        \${order.status === 'preparing' ? \`<button onclick="updateOrderStatus('\${order.id}', 'ready')" class="w-full bg-green-500 text-white py-1 rounded">Mark as Ready</button>\` : ''}
                    </div>
                </div>
            \`).join('');
        }
        
        function updateOrderStatus(orderId, newStatus) {
            db.ref('orders/' + orderId).update({ status: newStatus })
                .then(() => showNotification(\`Order status updated to \${newStatus}.\`, 'info'))
                .catch(err => showNotification('Error updating status.', 'error'));
        }
        
        function loadOwnerDashboard() {
            const totalOrders = allOrders.length;
            const totalRevenue = allOrders.reduce((sum, order) => sum + order.total, 0);
            document.getElementById('total-orders-stat').innerText = totalOrders;
            document.getElementById('total-revenue-stat').innerText = totalRevenue.toFixed(2);
            
            const summaryContainer = document.getElementById('all-orders-owner-summary');
            const sortedOrders = [...allOrders].sort((a, b) => new Date(b.date) - new Date(a.date));

            summaryContainer.innerHTML = sortedOrders.slice(0, 5).map(o => \`<p class="text-sm">Table \${o.table}: $\${o.total.toFixed(2)} - <span class="font-semibold">\${o.status}</span></p>\`).join('') || '<p>No orders yet.</p>';
        }

        // --- MENU MANAGEMENT (OWNER) ---
        function saveMenuData() {
            db.ref('settings/menuData').set(menuData)
                .then(() => showNotification('Menu saved successfully!', 'success'))
                .catch(err => showNotification('Error saving menu.', 'error'));
        }

        function renderMenuEditor() {
            const container = document.getElementById('menu-editor-container');
            container.innerHTML = '';
            const lang = 'en'; // Editor works on the English version as the base
            if (!menuData[lang] || !menuData[lang].categories) {
                container.innerHTML = '<p>Menu data is not available for editing.</p>';
                return;
            }

            menuData[lang].categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'p-4 bg-gray-100 rounded-lg';
                let itemsHtml = category.items.map(item => \`
                    <div class="flex justify-between items-center p-2 bg-white rounded shadow-sm">
                        <div>
                            <p class="font-bold">\${item.name}</p>
                            <p class="text-sm text-gray-600">$ \${item.price.toFixed(2)}</p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="openMenuEditorModal('\${item.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">Edit</button>
                            <button onclick="deleteMenuItem('\${item.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm">Delete</button>
                        </div>
                    </div>
                \`).join('');

                categoryDiv.innerHTML = \`
                    <h3 class="text-xl font-bold mb-2">\${category.name}</h3>
                    <div class="space-y-2">\${itemsHtml}</div>
                \`;
                container.appendChild(categoryDiv);
            });
        }
        
        function openMenuEditorModal(itemId = null) {
            const form = document.getElementById('menu-editor-form');
            form.reset();
            document.getElementById('menu-editor-modal').classList.remove('hidden');

            if (itemId) {
                document.getElementById('menu-editor-title').innerText = 'Edit Menu Item';
                document.getElementById('menu-item-id').value = itemId;

                const item = findMenuItem(itemId);
                let categoryName = '';
                 for (const lang in menuData) {
                    if (menuData[lang] && menuData[lang].categories) {
                        for (const cat of menuData[lang].categories) {
                            if (cat.items.some(i => i.id == itemId)) {
                                categoryName = cat.name;
                                break;
                            }
                        }
                    }
                    if (categoryName) break;
                }

                if (item) {
                    document.getElementById('menu-item-category').value = categoryName;
                    document.getElementById('menu-item-name').value = item.name;
                    document.getElementById('menu-item-description').value = item.description;
                    document.getElementById('menu-item-price').value = item.price;
                    document.getElementById('menu-item-tags').value = item.tags ? item.tags.join(', ') : '';
                }
            } else {
                document.getElementById('menu-editor-title').innerText = 'Add Menu Item';
                document.getElementById('menu-item-id').value = '';
            }
        }

        function closeMenuEditorModal() { document.getElementById('menu-editor-modal').classList.add('hidden'); }

        function saveMenuItem(event) {
            event.preventDefault();
            const id = document.getElementById('menu-item-id').value;
            const categoryName = document.getElementById('menu-item-category').value.trim();
            const name = document.getElementById('menu-item-name').value;
            const description = document.getElementById('menu-item-description').value;
            const price = parseFloat(document.getElementById('menu-item-price').value);
            const tags = document.getElementById('menu-item-tags').value.split(',').map(t => t.trim()).filter(t => t);

            if (id) { // Editing
                for (const l in menuData) {
                    if (menuData[l] && menuData[l].categories) {
                         menuData[l].categories.forEach(cat => {
                            const itemIndex = cat.items.findIndex(i => i.id == id);
                            if (itemIndex !== -1) {
                                cat.items[itemIndex] = { ...cat.items[itemIndex], name, description, price, tags };
                            }
                        });
                    }
                }
            } else { // Adding
                const newItemId = 'item-' + Date.now();
                const newItemData = { id: newItemId, name, description, price, tags };
                for (const l in menuData) {
                    if (menuData[l]) {
                        if (!menuData[l].categories) menuData[l].categories = [];
                        let category = menuData[l].categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                        if (!category) {
                            category = { name: categoryName, items: [] };
                            menuData[l].categories.push(category);
                        }
                        category.items.push(newItemData);
                    }
                }
            }
            
            saveMenuData();
            renderMenu();
            renderMenuEditor();
            closeMenuEditorModal();
        }
        
        function deleteMenuItem(itemId) {
            if (confirm('Are you sure you want to delete this item from all menus?')) {
                for (const lang in menuData) {
                     if (menuData[lang] && menuData[lang].categories) {
                        menuData[lang].categories.forEach(cat => {
                            cat.items = cat.items.filter(i => i.id != itemId);
                        });
                     }
                }
                saveMenuData();
                renderMenu();
                renderMenuEditor();
            }
        }

        // --- UTILS & OTHER ---
        function showNotification(message, type = 'info') {
             const container = document.getElementById('notifications-container');
            const color = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const notif = document.createElement('div');
            notif.className = \`text-white p-3 rounded shadow-lg \${color} animate-pulse\`;
            notif.innerText = message;
            container.appendChild(notif);
            setTimeout(() => {
                notif.classList.remove('animate-pulse');
                notif.style.transition = 'opacity 0.5s ease';
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 500);
            }, 3000);
        }

        function applySettings() { 
            const settings = {
                hotelName: document.getElementById('hotel-name-input').value,
                hotelAddress: document.getElementById('hotel-address-input').value,
                logoUrl: document.getElementById('logo-url-input').value,
                facebookUrl: document.getElementById('facebook-url-input').value,
                instagramUrl: document.getElementById('instagram-url-input').value,
                twitterUrl: document.getElementById('twitter-url-input').value,
                bgColor: document.getElementById('bg-color-input').value,
                textColor: document.getElementById('text-color-input').value,
            };
            db.ref('settings/branding').set(settings)
                .then(() => showNotification('General settings saved!', 'success'))
                .catch(err => showNotification('Error saving settings.', 'error'));
        }

        function loadSettings(settings) {
            const s = settings || {};
            document.getElementById('hotel-name').innerText = s.hotelName || "Hotel Name";
            document.getElementById('hotel-address').innerText = s.hotelAddress || "123 Main Street, Cityville, ST 12345";
            document.getElementById('logo').src = s.logoUrl || "https://via.placeholder.com/50";
            document.querySelector('#social-media a[href*="facebook"]').href = s.facebookUrl || "#";
            document.querySelector('#social-media a[href*="instagram"]').href = s.instagramUrl || "#";
            document.querySelector('#social-media a[href*="twitter"]').href = s.twitterUrl || "#";
            
            document.getElementById('hotel-name-input').value = s.hotelName || "";
            document.getElementById('hotel-address-input').value = s.hotelAddress || "";
            document.getElementById('logo-url-input').value = s.logoUrl || "";
            document.getElementById('facebook-url-input').value = s.facebookUrl || "";
            document.getElementById('instagram-url-input').value = s.instagramUrl || "";
            document.getElementById('twitter-url-input').value = s.twitterUrl || "";

            document.documentElement.style.setProperty('--primary-color', s.bgColor || '#f9fafb');
            document.documentElement.style.setProperty('--secondary-color', s.textColor || '#1f2937');
            document.getElementById('bg-color-input').value = s.bgColor || '#f9fafb';
            document.getElementById('text-color-input').value = s.textColor || '#1f2937';
        }
        
        document.getElementById('photo-input').addEventListener('change', function(event) {
             const previewContainer = document.getElementById('photo-preview-container');
            previewContainer.innerHTML = '';
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'max-w-full h-auto rounded shadow-md';
                    previewContainer.appendChild(img);
                }
                reader.readAsDataURL(file);
            }
        });
        
        function printAllOrders() {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>All Orders</title>');
            printWindow.document.write('<style>body{font-family:sans-serif;padding:20px} .order-item{border-bottom:1px solid #ccc;padding-bottom:1rem;margin-bottom:1rem} h1{text-align:center} h2{border-bottom:2px solid #000;padding-bottom:5px} ul{list-style:none;padding-left:0}</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(\`<h1>Order History Report</h1><p>Generated on: ${new Date().toLocaleString()}</p>\`);

            const sortedOrders = [...allOrders].sort((a,b) => new Date(b.date) - new Date(a.date));

            const reportContent = sortedOrders.map(order => \`
                <div class="order-item">
                    <h2>Order for Table/Room: ${order.table}</h2>
                    <p><strong>Date:</strong> ${new Date(order.date).toLocaleString()}</p>
                    <p><strong>Total:</strong> ${order.total.toFixed(2)}</p>
                    <p><strong>Status:</strong> ${order.status.toUpperCase()}</p>
                    ${order.preferences ? \`<p><strong>Preferences:</strong> ${order.preferences}</p>\` : ''}
                    <strong>Items:</strong>
                    <ul>
                        ${order.items.map(item => \`<li>- ${item.name} (${item.price.toFixed(2)})</li>\`).join('')}
                    </ul>
                </div>
            \`).join('');

            printWindow.document.write(reportContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus(); 
            setTimeout(function(){ printWindow.print(); }, 500);
        }

        // --- INITIALIZATION AND REAL-TIME LISTENERS ---
        async function initializeApp() {
            // Load guest's local order history first
            guestOrderHistory = JSON.parse(localStorage.getItem('guestOrderHistory')) || [];

            // Listener for Settings
            db.ref('settings').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    if(settings.branding) loadSettings(settings.branding);
                    if(settings.credentials) {
                        credentials = settings.credentials;
                         document.getElementById('new-username-input').value = credentials.username;
                    };
                    if(settings.menuData) {
                         menuData = settings.menuData;
                         renderMenu(); // Re-render menu when it changes
                    }
                } else {
                    // If no settings exist, create default ones
                    const defaultSettings = {
                        credentials: { username: 'owner', password: 'kitchenpass456' },
                        branding: { hotelName: 'Hotel Name', hotelAddress: '123 Main St', logoUrl: '', facebookUrl: '#', instagramUrl: '#', twitterUrl: '#', bgColor: '#f9fafb', textColor: '#1f2937' },
                        menuData: {
                            en: { categories: [{ name: "Main Courses", items: [{ id: "item-1", name: "Default Dish", price: 9.99, description: "This is a default item.", tags: [] }]}]},
                            am: { categories: [] }, om: { categories: [] }, ti: { categories: [] }
                        }
                    };
                    db.ref('settings').set(defaultSettings);
                }
            });

            // Listener for all Orders
            db.ref('orders').on('value', (snapshot) => {
                const ordersObject = snapshot.val();
                const oldOrderCount = allOrders.length;

                if (ordersObject) {
                    allOrders = Object.keys(ordersObject).map(key => ({
                        id: key, // The Firebase unique key is the ID
                        ...ordersObject[key]
                    }));
                } else {
                    allOrders = [];
                }
                
                // Alert for new orders
                if (userState.isLoggedIn && allOrders.length > oldOrderCount && oldOrderCount > 0) {
                     showNotification('A new order has been placed!', 'success');
                     document.getElementById('notification-sound').play();
                }

                // Update views if they are open
                if (!document.getElementById('all-orders-view').classList.contains('hidden')) renderAllOrders();
                if (!document.getElementById('kitchen-view').classList.contains('hidden')) renderKitchenOrders();
                if (!document.getElementById('owner-dashboard-view').classList.contains('hidden')) loadOwnerDashboard();
            });

            // Initial UI setup
            updateNav();
            showView('menu');
            renderCart();
            renderOrderHistory();
        }

        // --- START THE APP ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
https://restaurant-management-cef63-default-rtdb.firebaseio.com/
